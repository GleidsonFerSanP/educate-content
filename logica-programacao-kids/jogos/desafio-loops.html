<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéÆ</text></svg>">    <title>üîÅ Desafio dos Loops</title>
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        .grid {
            display: grid !important;
            grid-template-columns: repeat(5, 80px);
            grid-template-rows: repeat(5, 80px);
            gap: 5px;
            justify-content: center;
            margin: 30px auto;
            background: #E0E0E0;
            padding: 10px;
            border-radius: 15px;
            max-width: 450px;
            width: fit-content;
        }
        
        .celula {
            width: 80px;
            height: 80px;
            background: white;
            border: 2px solid #ccc;
            border-radius: 10px;
            display: flex !important;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .celula.estrela {
            background: #FFD93D !important;
        }
        
        .celula.coletada {
            background: #6BCF7F;
        }
        
        .programacao-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 30px 0;
        }
        
        .blocos-disponiveis {
            background: #f0f0f0;
            padding: 20px;
            border-radius: 15px;
        }
        
        .blocos-disponiveis h3 {
            color: #A960EE;
            margin-bottom: 15px;
        }
        
        .bloco-loop, .bloco-comando {
            background: white;
            border: 3px solid #A960EE;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .bloco-loop {
            background: linear-gradient(135deg, #A960EE, #FF6B9D);
            color: white;
        }
        
        .bloco-loop:hover, .bloco-comando:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .area-codigo {
            background: #2C3E50;
            color: white;
            padding: 20px;
            border-radius: 15px;
            min-height: 200px;
        }
        
        .area-codigo h3 {
            color: #6BCF7F;
            margin-bottom: 15px;
        }
        
        .linha-codigo {
            background: #34495E;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .linha-loop {
            background: #A960EE;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #FF6B9D;
        }
        
        .linha-loop-interna {
            background: #8B45D6;
            padding: 8px;
            margin: 5px 0 5px 20px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .btn-remover {
            background: #E74C3C;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .modal-loop {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 1000;
            min-width: 400px;
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        
        .input-repeticoes {
            font-size: 2em;
            text-align: center;
            padding: 10px;
            width: 100px;
            border: 3px solid #A960EE;
            border-radius: 10px;
            margin: 0 10px;
        }
    </style>
</head>
<body>
    <a href="../index.html" class="btn-voltar">‚Üê Voltar ao Menu</a>
    
    <div class="modal-overlay" id="modalOverlay" onclick="fecharModal()"></div>
    <div class="modal-loop" id="modalLoop">
        <h2 style="color: #A960EE; text-align: center;">üîÅ Criar Loop</h2>
        <div style="text-align: center; margin: 30px 0;">
            <p style="font-size: 1.3em; margin-bottom: 20px;">Repetir quantas vezes?</p>
            <input type="number" id="inputRepeticoes" class="input-repeticoes" value="3" min="1" max="10">
        </div>
        <div style="text-align: center;">
            <button class="btn" onclick="confirmarLoop()">‚úÖ Criar Loop</button>
            <button class="btn" onclick="fecharModal()" style="background: #E74C3C;">‚ùå Cancelar</button>
        </div>
    </div>

    <div class="container">
        <div class="jogo-container">
            <h1 class="jogo-titulo">üîÅ Desafio dos Loops</h1>
            <p style="font-size: 1.3em; text-align: center;">
                Use loops para repetir comandos e coletar todas as estrelas com MENOS c√≥digo!
            </p>
            
            <div class="pontuacao">
                ‚≠ê Estrelas: <span id="estrelas">0</span>/3 | 
                N√≠vel: <span id="nivel">1</span>/3 |
                üìù Linhas de c√≥digo: <span id="linhasCodigo">0</span>
            </div>

            <div id="feedback" class="feedback" style="display: none;"></div>

            <div class="jogo-area">
                <div id="grid" class="grid"></div>
                
                <div class="programacao-area">
                    <div class="blocos-disponiveis">
                        <h3>üß© Blocos Dispon√≠veis</h3>
                        <p style="color: #666; margin-bottom: 15px;">Clique para adicionar ao c√≥digo</p>
                        
                        <div class="bloco-loop" onclick="abrirModalLoop()">
                            <strong>üîÅ REPITA [N] VEZES</strong><br>
                            <small>Use para repetir comandos!</small>
                        </div>
                        
                        <div class="bloco-comando" onclick="adicionarComando('direita')">
                            ‚û°Ô∏è Mover para Direita
                        </div>
                        
                        <div class="bloco-comando" onclick="adicionarComando('baixo')">
                            ‚¨áÔ∏è Mover para Baixo
                        </div>
                        
                        <div class="bloco-comando" onclick="adicionarComando('coletar')">
                            ‚≠ê Coletar Estrela
                        </div>
                    </div>
                    
                    <div class="area-codigo">
                        <h3>üíª Seu Programa</h3>
                        <div id="codigo">
                            <p style="color: #999;">Adicione blocos para come√ßar...</p>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" onclick="executarCodigo()">‚ñ∂Ô∏è Executar C√≥digo</button>
                    <button class="btn" onclick="limparCodigo()">üóëÔ∏è Limpar Tudo</button>
                    <button class="btn" onclick="gerarNovoDesafio()" style="background: #FF6B9D;">
                        üé≤ Novo Desafio Aleat√≥rio
                    </button>
                    <button class="btn" onclick="proximoNivel()" id="btn-proximo" style="display: none;">
                        ‚û°Ô∏è Pr√≥ximo N√≠vel
                    </button>
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <a href="../topicos/loops.html" class="btn">üìö Rever o T√≥pico</a>
                <a href="../index.html" class="btn">üè† Menu Principal</a>
            </div>
        </div>
    </div>

    <script src="../js/main.js"></script>
    <script>
        let nivelAtual = 0;
        let roboX = 0;
        let roboY = 0;
        let programa = []; // Array de objetos: {tipo: 'comando'|'loop', acao: 'direita'|'baixo'|'coletar', repeticoes: N}
        let estrelasColetadas = 0;
        let loopEmEdicao = null;
        let nivelAtualConfig = null; // Guarda o n√≠vel atual (pode ser gerado ou fixo)
        
        const niveis = [
            { 
                estrelas: [[1,0], [2,0], [3,0]], 
                meta: 3, 
                dica: "üí° Dica: Use um loop REPITA 3 VEZES com 'Mover Direita' e 'Coletar'!",
                codigoIdeal: 6 // Com loop: repita 3 vezes (direita, coletar) = 1 linha loop + 2 linhas dentro
            },
            { 
                estrelas: [[0,1], [0,2], [0,3]], 
                meta: 3, 
                dica: "üí° Dica: Use um loop REPITA 3 VEZES com 'Mover Baixo' e 'Coletar'!",
                codigoIdeal: 6
            },
            { 
                estrelas: [[1,1], [2,1], [3,1]], 
                meta: 3, 
                dica: "üí° Dica: Primeiro mova para baixo, depois use loop para ir para direita!",
                codigoIdeal: 8
            }
        ];

        function gerarPosicaoAleatoria(posicaoRobo = [0, 0]) {
            let x, y;
            do {
                x = Math.floor(Math.random() * 5);
                y = Math.floor(Math.random() * 5);
            } while (x === posicaoRobo[0] && y === posicaoRobo[1]); // N√£o gerar na posi√ß√£o do rob√¥
            
            return [x, y];
        }

        function gerarEstrelasAleatorias(quantidade = 3) {
            const estrelas = [];
            const posicoesUsadas = new Set(['0,0']); // Rob√¥ come√ßa em [0,0]
            
            while (estrelas.length < quantidade) {
                const pos = gerarPosicaoAleatoria();
                const key = `${pos[0]},${pos[1]}`;
                
                if (!posicoesUsadas.has(key)) {
                    estrelas.push(pos);
                    posicoesUsadas.add(key);
                }
            }
            
            return estrelas;
        }

        function gerarNovoDesafio() {
            const quantidadeEstrelas = Math.floor(Math.random() * 3) + 3; // 3 a 5 estrelas
            const estrelas = gerarEstrelasAleatorias(quantidadeEstrelas);
            
            nivelAtualConfig = {
                estrelas: estrelas,
                meta: quantidadeEstrelas,
                dica: `üé≤ Desafio Aleat√≥rio! Colete ${quantidadeEstrelas} estrelas usando loops!`,
                codigoIdeal: quantidadeEstrelas * 2 + 2,
                aleatorio: true
            };
            
            iniciarNivel();
        }

        function iniciarNivel() {
            // Se n√£o tem config customizada, usa o n√≠vel da sequ√™ncia
            if (!nivelAtualConfig || !nivelAtualConfig.aleatorio) {
                nivelAtualConfig = niveis[nivelAtual];
            }
            
            const nivel = nivelAtualConfig;
            roboX = 0;
            roboY = 0;
            programa = [];
            estrelasColetadas = 0;
            
            console.log('Iniciando n√≠vel:', nivelAtual + 1);
            console.log('Estrelas do n√≠vel:', nivel.estrelas);
            
            document.getElementById('nivel').textContent = nivelAtual + 1;
            document.getElementById('estrelas').textContent = '0';
            document.getElementById('linhasCodigo').textContent = '0';
            document.getElementById('btn-proximo').style.display = 'none';
            limparCodigo();
            
            // Resetar flag de aleat√≥rio para pr√≥ximas chamadas
            if (nivelAtualConfig && nivelAtualConfig.aleatorio) {
                document.getElementById('nivel').textContent = 'üé≤';
            }
            
            const grid = document.getElementById('grid');
            if (!grid) {
                console.error('Elemento #grid n√£o encontrado!');
                return;
            }
            
            grid.innerHTML = '';
            console.log('Grid limpo, criando c√©lulas...');
            
            let celulasComEstrela = 0;
            
            for (let y = 0; y < 5; y++) {
                for (let x = 0; x < 5; x++) {
                    const celula = document.createElement('div');
                    celula.className = 'celula';
                    celula.id = `cel-${x}-${y}`;
                    
                    const temEstrela = nivel.estrelas.some(e => e[0] === x && e[1] === y);
                    const ehPosicaoRobo = (x === 0 && y === 0);
                    
                    if (temEstrela) {
                        celula.classList.add('estrela');
                        celula.innerHTML = '‚≠ê';
                        celulasComEstrela++;
                        console.log(`Estrela criada em [${x},${y}]`);
                    }
                    
                    if (ehPosicaoRobo) {
                        // Se tiver estrela na posi√ß√£o do rob√¥, mostra ambos
                        if (temEstrela) {
                            celula.innerHTML = 'ü§ñ‚≠ê';
                        } else {
                            celula.innerHTML = 'ü§ñ';
                        }
                    }
                    
                    grid.appendChild(celula);
                }
            }
            
            console.log(`Total de c√©lulas com estrela: ${celulasComEstrela}`);
            console.log(`Total de c√©lulas no grid: ${grid.children.length}`);
            
            // Mostrar dica
            setTimeout(() => {
                const feedbackDiv = document.getElementById('feedback');
                feedbackDiv.textContent = nivel.dica;
                feedbackDiv.className = 'feedback';
                feedbackDiv.style.display = 'block';
                feedbackDiv.style.background = '#E3F2FD';
                feedbackDiv.style.color = '#1976D2';
                feedbackDiv.style.border = '2px solid #1976D2';
                
                setTimeout(() => {
                    feedbackDiv.style.display = 'none';
                }, 5000);
            }, 500);
        }

        function abrirModalLoop() {
            document.getElementById('modalOverlay').style.display = 'block';
            document.getElementById('modalLoop').style.display = 'block';
            document.getElementById('inputRepeticoes').value = 3;
            document.getElementById('inputRepeticoes').focus();
        }

        function fecharModal() {
            document.getElementById('modalOverlay').style.display = 'none';
            document.getElementById('modalLoop').style.display = 'none';
        }

        function confirmarLoop() {
            const repeticoes = parseInt(document.getElementById('inputRepeticoes').value);
            if (repeticoes < 1 || repeticoes > 10) {
                alert('‚ùå Digite um n√∫mero entre 1 e 10!');
                return;
            }
            
            programa.push({
                tipo: 'loop',
                repeticoes: repeticoes,
                comandos: []
            });
            
            loopEmEdicao = programa.length - 1;
            fecharModal();
            atualizarCodigo();
            tocarSomAcerto();
        }

        function adicionarComando(acao) {
            if (loopEmEdicao !== null) {
                // Adiciona dentro do loop
                programa[loopEmEdicao].comandos.push({
                    tipo: 'comando',
                    acao: acao
                });
            } else {
                // Adiciona comando normal
                programa.push({
                    tipo: 'comando',
                    acao: acao
                });
            }
            atualizarCodigo();
        }

        function removerItem(index, dentroLoop = false, loopIndex = -1) {
            if (dentroLoop && loopIndex >= 0) {
                programa[loopIndex].comandos.splice(index, 1);
            } else {
                if (programa[index].tipo === 'loop' && loopEmEdicao === index) {
                    loopEmEdicao = null;
                }
                programa.splice(index, 1);
                // Atualizar loopEmEdicao se necess√°rio
                if (loopEmEdicao !== null && loopEmEdicao > index) {
                    loopEmEdicao--;
                }
            }
            atualizarCodigo();
        }

        function fecharLoop(index) {
            if (loopEmEdicao === index) {
                loopEmEdicao = null;
                tocarSomAcerto();
            }
            atualizarCodigo();
        }

        function atualizarCodigo() {
            const codigoDiv = document.getElementById('codigo');
            let linhasCodigo = 0;
            
            if (programa.length === 0) {
                codigoDiv.innerHTML = '<p style="color: #999;">Adicione blocos para come√ßar...</p>';
                document.getElementById('linhasCodigo').textContent = '0';
                return;
            }
            
            let html = '';
            programa.forEach((item, i) => {
                if (item.tipo === 'loop') {
                    linhasCodigo++; // Conta a linha do loop
                    const aberto = loopEmEdicao === i;
                    html += `
                        <div class="linha-loop">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong>üîÅ REPITA ${item.repeticoes} VEZES {</strong>
                                <div>
                                    ${aberto ? '<button class="btn-remover" onclick="fecharLoop(' + i + ')">‚úÖ Fechar Loop</button>' : ''}
                                    <button class="btn-remover" onclick="removerItem(' + i + ')">‚ùå</button>
                                </div>
                            </div>
                    `;
                    
                    if (item.comandos.length === 0 && aberto) {
                        html += '<p style="color: #FFD93D; font-style: italic; margin-left: 20px;">‚Üê Adicione comandos dentro do loop</p>';
                    }
                    
                    item.comandos.forEach((cmd, j) => {
                        linhasCodigo++; // Conta comandos dentro do loop
                        html += `
                            <div class="linha-loop-interna">
                                <span>${obterIconeComando(cmd.acao)} ${cmd.acao.toUpperCase()}</span>
                                <button class="btn-remover" onclick="removerItem(${j}, true, ${i})">‚ùå</button>
                            </div>
                        `;
                    });
                    
                    html += `<div style="margin-top: 10px;"><strong>}</strong></div>`;
                    html += `</div>`;
                } else {
                    linhasCodigo++; // Conta comando normal
                    html += `
                        <div class="linha-codigo">
                            <span>${obterIconeComando(item.acao)} ${item.acao.toUpperCase()}</span>
                            <button class="btn-remover" onclick="removerItem(${i})">‚ùå</button>
                        </div>
                    `;
                }
            });
            
            if (loopEmEdicao !== null) {
                html += '<p style="color: #FFD93D; margin-top: 15px; font-weight: bold;">‚ö° Adicionando comandos no loop... Clique "Fechar Loop" quando terminar!</p>';
            }
            
            codigoDiv.innerHTML = html;
            document.getElementById('linhasCodigo').textContent = linhasCodigo;
        }

        function obterIconeComando(acao) {
            const icones = {
                'direita': '‚û°Ô∏è',
                'baixo': '‚¨áÔ∏è',
                'esquerda': '‚¨ÖÔ∏è',
                'cima': '‚¨ÜÔ∏è',
                'coletar': '‚≠ê'
            };
            return icones[acao] || '‚ùì';
        }

        function limparCodigo() {
            programa = [];
            loopEmEdicao = null;
            atualizarCodigo();
        }

        async function executarCodigo() {
            if (programa.length === 0) {
                alert('‚ùå Adicione blocos ao programa primeiro!');
                return;
            }
            
            if (loopEmEdicao !== null) {
                alert('‚ö†Ô∏è Feche o loop antes de executar!');
                return;
            }

            roboX = 0;
            roboY = 0;
            estrelasColetadas = 0;
            
            // Resetar grid
            document.querySelectorAll('.celula.coletada').forEach(cel => {
                cel.classList.remove('coletada');
                if (cel.innerHTML === '‚úÖ') {
                    cel.innerHTML = '‚≠ê';
                }
            });

            for (const item of programa) {
                if (item.tipo === 'loop') {
                    for (let rep = 0; rep < item.repeticoes; rep++) {
                        for (const cmd of item.comandos) {
                            await executarComando(cmd.acao);
                        }
                    }
                } else {
                    await executarComando(item.acao);
                }
            }

            await sleep(500);
            verificarVitoria();
        }

        async function executarComando(acao) {
            await sleep(400);
            
            // Limpar rob√¥ da posi√ß√£o atual
            const celulaAnterior = document.getElementById(`cel-${roboX}-${roboY}`);
            celulaAnterior.innerHTML = celulaAnterior.classList.contains('coletada') ? '‚úÖ' : 
                                      celulaAnterior.classList.contains('estrela') ? '‚≠ê' : '';
            
            // Mover rob√¥
            if (acao === 'direita' && roboX < 4) roboX++;
            else if (acao === 'esquerda' && roboX > 0) roboX--;
            else if (acao === 'baixo' && roboY < 4) roboY++;
            else if (acao === 'cima' && roboY > 0) roboY--;
            else if (acao === 'coletar') {
                const celula = document.getElementById(`cel-${roboX}-${roboY}`);
                if (celula.classList.contains('estrela') && !celula.classList.contains('coletada')) {
                    estrelasColetadas++;
                    celula.classList.add('coletada');
                    celula.innerHTML = 'ü§ñ‚úÖ';
                    document.getElementById('estrelas').textContent = estrelasColetadas;
                    tocarSomAcerto();
                    await sleep(200);
                    return;
                }
            }
            
            // Mostrar rob√¥ na nova posi√ß√£o
            const celulaAtual = document.getElementById(`cel-${roboX}-${roboY}`);
            if (celulaAtual.classList.contains('coletada')) {
                celulaAtual.innerHTML = 'ü§ñ‚úÖ';
            } else {
                celulaAtual.innerHTML = celulaAtual.classList.contains('estrela') ? 'ü§ñ‚≠ê' : 'ü§ñ';
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function verificarVitoria() {
            const nivel = niveis[nivelAtual];
            const feedback = document.getElementById('feedback');
            const linhas = parseInt(document.getElementById('linhasCodigo').textContent);
            
            if (estrelasColetadas === nivel.meta) {
                let mensagem = 'üéâ Parab√©ns! Voc√™ coletou todas as estrelas!';
                
                if (linhas <= nivel.codigoIdeal) {
                    mensagem += '<br>‚≠ê‚≠ê‚≠ê C√≥digo perfeito! Voc√™ usou loops de forma eficiente!';
                } else {
                    mensagem += '<br>üí° Voc√™ usou ' + linhas + ' linhas. Tente usar loops para usar menos c√≥digo!';
                }
                
                mostrarFeedback(mensagem, 'sucesso');
                document.getElementById('btn-proximo').style.display = 'inline-block';
                criarConfetes();
            } else {
                mostrarFeedback(`‚ùå Voc√™ coletou ${estrelasColetadas}/${nivel.meta} estrelas. Tente novamente!`, 'erro');
            }
        }

        function proximoNivel() {
            nivelAtual++;
            if (nivelAtual < niveis.length) {
                iniciarNivel();
            } else {
                finalizarJogo();
            }
        }

        function finalizarJogo() {
            const jogo = document.querySelector('.jogo-area');
            jogo.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <h2 style="font-size: 3em;">üèÜ</h2>
                    <h2 style="color: #A960EE; margin: 20px 0;">PARAB√âNS!</h2>
                    <p style="font-size: 1.5em;">
                        Voc√™ completou todos os n√≠veis do Desafio dos Loops!
                    </p>
                    <p style="font-size: 1.3em; margin: 20px 0; color: #666;">
                        Agora voc√™ entende como loops economizam c√≥digo e tornam<br>
                        a programa√ß√£o mais eficiente! üîÅ
                    </p>
                    <div style="background: #f0f0f0; padding: 20px; border-radius: 15px; margin: 20px auto; max-width: 500px;">
                        <h3 style="color: #A960EE;">O que voc√™ aprendeu:</h3>
                        <ul style="text-align: left; margin: 10px 0;">
                            <li>‚úÖ Loops repetem comandos automaticamente</li>
                            <li>‚úÖ Economizam linhas de c√≥digo</li>
                            <li>‚úÖ Tornam programas mais eficientes</li>
                            <li>‚úÖ S√£o essenciais na programa√ß√£o!</li>
                        </ul>
                    </div>
                    <button class="btn" onclick="location.reload()">üîÑ Jogar Novamente</button>
                    <a href="../index.html" class="btn">üè† Menu Principal</a>
                </div>
            `;
            criarConfetes();
            salvarProgresso('desafio-loops', true);
        }

        window.addEventListener('load', iniciarNivel);
    </script>
</body>
</html>
